<!DOCTYPE html>
<html>
<body>

<script>
//------Vars--------
//Canvas Vars
var c = document.createElement("canvas");

var cwidth=300;
var cheight=300;

//var c = document.getElementById("canvas");

c.width =cwidth;
c.height=cheight;
c.style.backgroundColor= "#000000";

var ctx = c.getContext("2d");
var selected = 0;

var commandBar = document.createElement("div");
var digButton = document.createElement("input");
var blockButton = document.createElement("input");
var parachuteButton = document.createElement("input");

//Lemming Vars
var size = 5;
var gravity = size;
var maxFallHeight = 4;
var digDuration = 50;

//Game Vars
var maxPop = 5; 
var currentPop;
var graveyardCount=0;

var savedPop = 0;
var reqSaved = 3;

var a = new Array(maxPop);
var spawnRate = 50;
var time = 0;

var currMoveTick = 0;
var moveTick = size;

var entx=15;
var enty=15;
var extx=2;
var exty=27;

var ent = new entrance(entx,enty);
var ext = new exit(extx,exty);
// Maps
var e = "_"; // empty
var w = "o"; // obstacle
var b = "+"; // blocker lemming  

var map = new Array(30);


// GUI
var popDisplay = document.createElement("P");
var missionDisplay = document.createElement("P"); 

//Objects
function lemming(id,mapx,mapy, direction){
   this.id = id;
   this.mapx= mapx;
   this.mapy= mapy;
   this.x= this.mapx*(size*2) + size;
   this.y= this.mapy*(size*2) + size;
   this.direction = direction;
   this.falling = false;
   this.fallHeight = this.y;

   this.actionTime=0;

   this.busy = false;    // flag to stop moving around
   this.blocking = false;  // flag to become a blocker
   this.digging = false;   // flag to become a digger
   this.parachute = false; // flag to become a para trooper
   


   this.turnAround = function(){
      if (this.direction=="LEFT") this.direction = "RIGHT";
      else this.direction = "LEFT";
   }

   // Smooth grid based movement (only graphical changes)
   this.move = function(){
      if (map[this.mapy+1][this.mapx]==w){
         if (!this.busy){
            if (this.direction=="LEFT") this.x--;
            else this.x++;
         }
      }
      else {
         this.y++;
      }
   }
   
   this.fall = function(){
      this.mapy ++ ; 
      if(!this.falling) {
         this.fallHeight=this.mapy;
         this.falling = true;
      }

      if (this.mapy==map.length-1) this.kill();
   }

   this.stopFall= function(){
      if (this.falling) {
         this.falling= false;
         if(this.mapy-this.fallHeight>maxFallHeight  && !this.parachute ) this.kill();
         if (this.blocking)map[this.mapy][this.mapx]=b;
      }  
      if (this.parachute) this.parachute=false;
   }

   this.updateActualCoords = function(){
      this.x= this.mapx*(size*2) +size;
      this.y= this.mapy*(size*2) +size;
   }
 
   // Actual grid based movement (logical changes)
   this.transition = function(){
      if (map[this.mapy+1][this.mapx]==e)  this.fall();
      else {
         this.stopFall();
         if(!this.busy){
            if (this.direction=="LEFT"){
               this.mapx--; 
            }
            else if (this.direction=="RIGHT"){
               this.mapx++;
            }
         }
         if(this.mapx >= map[0].length-1 || this.mapx <= 1 || (map[this.mapy][this.mapx-1]!=e && this.direction=="LEFT") || (map[this.mapy][this.mapx+1]!=e && this.direction=="RIGHT")) this.turnAround();
         
      }
      this.updateActualCoords();
   }

   this.setBlocker = function(){
      if (!this.busy){
         this.blocking = true;
         this.busy = true;
         if (!this.falling)map[this.mapy][this.mapx]=b;
      }
   }

   this.setDigger = function(){
      if (!this.busy){
         this.digging=true;
         this.busy = true;
         if (!this.falling) this.actionStartTime=time;
      }
   }

   this.setParaTrooper = function(){
      this.parachute = true;
   }

   this.dig = function(){   
        if (this.actionTime==digDuration){
            map[this.mapy+1][this.mapx]=e;
            this.actionTime=0;
            if (map[this.mapy+2][this.mapx]==e){
               this.digging=false;
               this.busy=false; 
            }
        }
        else this.actionTime++;     
   }

   this.kill = function(){
      killLemming(this.id);
   }

   this.save = function(){
      ext.lemmingExit(this.id);
   }

   this.draw = function(){
      drawCircle(this.x,this.y,size,"#0000FF"); 
      if(this.falling && this.parachute) drawCircle(this.x, this.y - size, size, "#00FFFF");
   }

   this.update = function(){
      this.draw();
      if (this.digging) this.dig();
    

      if(this.mapx == extx && this.mapy == exty) this.save();
   }
}

// Entrance
function entrance(mapx,mapy){
   var mapx=mapx;
   var mapy=mapy;
   var x = mapx*(size*2);
   var y = mapy*(size*2); 
   var w = size*2;
   var h = size*2;

   this.draw = function(){
       drawRect(x,y,w,h, "#FF0000");
   }
}

// Exit
function exit(mapx,mapy){
   var mapx=mapx;
   var mapy=mapy;
   var x = mapx*(size*2);
   var y = mapy*(size*2); 
   var w = size*2;
   var h = size*2;

   this.draw = function(){
       drawRect(x,y,w,h, "#00FF00");
   }

   this.lemmingExit = function(lemmingId){
       saveLemming(lemmingId);
   }
}


// Init
function init(){
   document.body.appendChild(popDisplay); 
   document.body.appendChild(missionDisplay);

   document.body.appendChild(c);

   loadButtons();
   
   currentPop = 0;
   
   updatePopDisplay();
   updateMissionDisplay();
   
   
   initMap();
}

// for debugging
function loadTestMap(){
    for (var i=0;i<30;i++) {
         map[i][0]=w;
         map[i][map.length-1]=w;
         map[20][i]=w;
         map[21][i]=w;
         map[24][i]=w;
    }
    map[24][15]= e;

    for (var i=0;i<30;i++) map[28][i]=w;
    map[28][28]= e;

}


function initMap(){
   for (var y = 0 ; y < 30; y++){
        map[y] = new Array(30);
        for (var x = 0; x < 30; x++){
            map[y][x] = e;
        }
   }
   loadTestMap();  
}

function loadButtons(){
   document.body.appendChild(commandBar);


   digButton.type = 'button';
   blockButton.type = 'button';
   parachuteButton.type = 'button';

   digButton.value = "DIG";
   blockButton.value = "BLOCK";
   parachuteButton.value = "PARACHUTE";

   digButton.id = 'dig';
   blockButton.id = 'block';
   parachuteButton.id = 'parachute';

   digButton.onmouseup = function(){
      if(a[selected]!=null){
         a[selected].setDigger();
         selected++;
      }
   }

   blockButton.onmouseup = function(){
      if(a[selected]!=null) {
         a[selected].setBlocker();
         selected++;
      }
   }

   parachuteButton.onmouseup = function(){
      if(a[selected]!=null){
         a[selected].setParaTrooper();
         selected++;
      }
         
   }

   commandBar.appendChild(digButton);
   commandBar.appendChild(blockButton);
   commandBar.appendChild(parachuteButton);
}

// --------Functions ----
function drawCircle(x,y,size,color){
   ctx.beginPath();
   ctx.fillStyle = color;
   ctx.arc(x,y,size,0,2*Math.PI);
   
   ctx.fill();
   ctx.stroke();
   ctx.closePath();
} 


function drawRect(x,y,width, height, color){
    ctx.fillStyle = color;
    ctx.fillRect(x,y,width,height);
    
    ctx.stroke(); 
    
}


function clear(){
   ctx.clearRect(0, 0, cwidth, cheight);
}


function drawMap(){
   for (var y = 0 ; y < map.length; y++){
       for (var x = 0 ; x < map.length; x++){
           if (map[y][x] == w){
               ctx.fillStyle = "#2B2B2B";
               ctx.fillRect(x*size*2,y*size*2,size*2,size*2);
    
               ctx.stroke();
           }
       }
   }
}

function updatePopDisplay(){
   var ctr = 0;
   for(var i =0; i<a.length; i++)
      if (a[i]!=null)ctr++;
   
   currentPop=ctr;
   popDisplay.innerHTML = "OUT: "+ currentPop;
}

function updateMissionDisplay(){
   missionDisplay.innerHTML = "SAVED: "+ savedPop+" / "+ reqSaved;
}

function update(){
   clear();
   updatePopDisplay();
   drawMap();
   
   ent.draw();
   ext.draw();

   for (var i = 0; i < a.length; i++)  
     if (a[i] !=null)a[i].update();
   
   
}

function moveLemmings(){
    if (currMoveTick<moveTick){
       for (var i = 0; i <a.length; i++)
          if (a[i] !=null) a[i].move();
       
       currMoveTick++;  
    }
    else{
       for (var i = 0; i < a.length; i++)  
          if (a[i] !=null) a[i].transition();
       currMoveTick=0;
    }
}

function spawnLemmings(){
    for (var i = 0; i < a.length; i++)  
       if (time ==(100 - spawnRate)*i +100)
           a[i] = new lemming(i,entx,enty,"RIGHT");
       
}

function killLemming(id){
    a[id]=null;  
    graveyardCount++;
}

function saveLemming(id){
    a[id]=null;
    savedPop++;
    updateMissionDisplay();
}

function gameLoop(){     
   spawnLemmings();

   moveLemmings();

   //if (a[0]!=null) if (time==520) a[0].setBlocker();
   //if (a[1]!=null) if (time==300) a[1].setDigger();
   update();
   time ++; 
   
  
}


// ---------MAIN PROGRAM ---------

init();
setInterval(gameLoop, 30);
</script>

</body>
</html> 
